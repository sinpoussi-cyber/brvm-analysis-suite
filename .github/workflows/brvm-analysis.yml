# ==============================================================================
# WORKFLOW GITHUB ACTIONS - VERSION FINALE STABLE V3.0
# ==============================================================================
# - Utilise les derni√®res versions des actions pour √©viter les erreurs de d√©pr√©ciation.
# - Injecte correctement toutes les cl√©s secr√®tes comme variables d'environnement.
# - Met en cache les d√©pendances Python pour acc√©l√©rer les ex√©cutions futures.
# - G√®re de mani√®re robuste l'upload des rapports g√©n√©r√©s.
# ==============================================================================

name: Analyse Quotidienne BRVM

on:
  schedule:
    - cron: '0 20 * * 1-5' # Ex√©cution du Lundi au Vendredi √† 20h00 UTC
  workflow_dispatch: # Permet de lancer manuellement

jobs:
  daily-analysis:
    runs-on: ubuntu-latest
    
    steps:
      # √âtape 1: R√©cup√©ration du code source de votre d√©p√¥t
      - name: Checkout du code
        uses: actions/checkout@v4

      # √âtape 2: Mise en place de l'environnement Python 3.10
      - name: Mise en place de Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          # NOUVEAU : Optimisation des performances en mettant en cache les paquets
          cache: 'pip'

      # √âtape 3: Installation des d√©pendances list√©es dans requirements.txt
      - name: Installation des d√©pendances
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      # √âtape 4: Ex√©cution de la suite d'analyse compl√®te
      # Cette √©tape utilise les secrets du d√©p√¥t pour se connecter √† la DB et √† l'API OpenAI
      - name: Ex√©cution de la suite d'analyse
        env:
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "üöÄ D√©marrage de la suite d'analyse BRVM avec OpenAI..."
          python main.py

      # √âtape 5: Sauvegarde des rapports Word g√©n√©r√©s comme "artefacts"
      # Le fichier sera disponible au t√©l√©chargement √† la fin de l'ex√©cution
      - name: Upload des rapports g√©n√©r√©s
        uses: actions/upload-artifact@v4
        with:
          name: Rapports-Analyse-BRVM
          path: Rapport_*.docx
          if-no-files-found: warn # Affiche un avertissement au lieu d'une erreur si aucun rapport n'est trouv√©
