# ==============================================================================
# ORCHESTRATEUR PRINCIPAL - BRVM ANALYSIS SUITE (V1.6 - AVEC DEBUG)
# ==============================================================================
import os
import logging
import sys

# Importer les modules de chaque √©tape
import data_collector
import fundamental_analyzer
import technical_analyzer
import report_generator

# Configuration du logging
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s: %(message)s')

def main():
    """
    Fonction principale qui ex√©cute la suite d'analyse BRVM dans l'ordre.
    """
    logging.info("üöÄ D√âMARRAGE DE LA SUITE D'ANALYSE BRVM COMPL√àTE üöÄ")
    
    # --- SECTION DE D√âBOGAGE DES SECRETS ---
    logging.info("="*60)
    logging.info("DIAGNOSTIC : V√âRIFICATION DES SECRETS RE√áUS PAR PYTHON")
    spreadsheet_id = os.environ.get('SPREADSHEET_ID')
    drive_folder_id = os.environ.get('DRIVE_FOLDER_ID')
    api_key_1 = os.environ.get('GOOGLE_API_KEY_1')

    logging.info(f"Valeur lue pour SPREADSHEET_ID: '{spreadsheet_id}'")
    logging.info(f"Valeur lue pour DRIVE_FOLDER_ID: '{drive_folder_id}'")
    logging.info(f"Valeur lue pour GOOGLE_API_KEY_1: '{'Pr√©sente' if api_key_1 else 'Absente'}'")
    logging.info("="*60)
    # --- FIN DE LA SECTION DE D√âBOGAGE ---

    if not spreadsheet_id or not drive_folder_id:
        logging.error("‚ùå Les secrets SPREADSHEET_ID ou DRIVE_FOLDER_ID ne sont pas d√©finis. V√©rifiez la configuration des secrets du d√©p√¥t et le fichier .yml.")
        sys.exit(1)
        
    data_collector.SPREADSHEET_ID = spreadsheet_id
    technical_analyzer.SPREADSHEET_ID = spreadsheet_id

    # --- √âtape 1 : Collecte des donn√©es ---
    try:
        data_collector.run_data_collection()
        logging.info("‚úÖ √âtape 1/4 (Collecte de donn√©es) termin√©e avec succ√®s.")
    except Exception as e:
        logging.error(f"‚ùå √âchec critique √† l'√©tape 1 (Collecte de donn√©es): {e}", exc_info=True)
        sys.exit(1)

    # --- √âtape 2 : Analyse technique ---
    try:
        logging.info("="*60)
        logging.info("√âTAPE 2 : D√âMARRAGE DE L'ANALYSE TECHNIQUE")
        logging.info("="*60)
        technical_analyzer.run_technical_analysis()
        logging.info("‚úÖ √âtape 2/4 (Analyse technique) termin√©e avec succ√®s.")
    except Exception as e:
        logging.error(f"‚ùå √âchec √† l'√©tape 2 (Analyse technique): {e}", exc_info=True)
        sys.exit(1)

    # --- √âtape 3 : Analyse fondamentale ---
    fundamental_results = {}
    new_fundamental_analyses = []
    try:
        if not any(os.environ.get(f'GOOGLE_API_KEY_{i}') for i in range(1, 20)):
            logging.warning("‚ö†Ô∏è Aucune variable d'environnement GOOGLE_API_KEY_n n'est d√©finie. L'√©tape fondamentale sera saut√©e.")
        else:
            analyzer = fundamental_analyzer.BRVMAnalyzer(spreadsheet_id=spreadsheet_id)
            fundamental_results, new_fundamental_analyses = analyzer.run_and_get_results()
            logging.info("‚úÖ √âtape 3/4 (Analyse fondamentale) termin√©e avec succ√®s.")
    except Exception as e:
        logging.error(f"‚ùå √âchec √† l'√©tape 3 (Analyse fondamentale): {e}", exc_info=True)

    # --- √âtape 4 : G√©n√©ration du rapport de synth√®se ---
    try:
        if not any(os.environ.get(f'GOOGLE_API_KEY_{i}') for i in range(1, 20)):
            logging.warning("‚ö†Ô∏è Aucune cl√© API n'est disponible. Impossible de g√©n√©rer les rapports.")
        else:
            final_report_generator = report_generator.ComprehensiveReportGenerator(
                spreadsheet_id=spreadsheet_id,
                drive_folder_id=drive_folder_id
            )
            final_report_generator.generate_report(fundamental_results, new_fundamental_analyses)
            logging.info("‚úÖ √âtape 4/4 (G√©n√©ration des rapports) termin√©e avec succ√®s.")
    except Exception as e:
        logging.error(f"‚ùå √âchec √† l'√©tape 4 (G√©n√©ration des rapports): {e}", exc_info=True)

    logging.info("üèÅ SUITE D'ANALYSE BRVM COMPL√àTE TERMIN√âE üèÅ")


if __name__ == "__main__":
    main()
